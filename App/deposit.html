<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit Funds | Pocket Investie</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #2ecc71;
            --dark: #2c3e50;
            --danger: #e74c3c;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 2rem;
        }
        .deposit-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .deposit-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .deposit-header h1 {
            color: var(--dark);
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .cta-button {
            display: block;
            width: 100%;
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .cta-button:hover {
            background-color: #27ae60;
        }
        .loading {
            display: inline-block;
            margin-left: 10px;
        }
        .minimum-note {
            font-size: 0.9rem;
            color: #777;
            margin-top: 0.5rem;
        }
        .error-message {
            color: var(--danger);
            margin-top: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="deposit-container">
        <div class="deposit-header">
            <h1><i class="fas fa-money-bill-wave"></i> Deposit Funds</h1>
            <p>Add money to your Pocket Investie wallet securely</p>
        </div>

        <form id="depositForm">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" placeholder="your@email.com" required>
            </div>
            <div class="form-group">
                <label for="amount">Amount (₦)</label>
                <input type="number" id="amount" min="2000" placeholder="Minimum: ₦2,000" required>
                <p class="minimum-note">Minimum deposit: ₦2,000</p>
            </div>
            <button type="button" id="payButton" class="cta-button">
                Proceed to Payment
                <i class="fas fa-spinner fa-spin loading" id="spinner" style="display: none;"></i>
            </button>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </form>
    </div>

    <!-- Paystack Inline JS -->
    <script src="https://js.paystack.co/v1/inline.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-functions-compat.js"></script>
    
    <!-- Your Firebase Config (Initialize with your actual config) -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA5LqCUYEaAX5lR5x25D7nxu63loA-goFc",
            authDomain: "pocket-investie-412fe.firebaseapp.com",
            projectId: "pocket-investie-412fe",
            storageBucket: "pocket-investie-412fe.firebasestorage.app",
            messagingSenderId: "218119968222",
            appId: "1:218119968222:web:522cc4142df3a90cb0f94f"
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <!-- Payment Handler -->
    <script>
        // Initialize Firebase services
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();
        
        // DOM elements
        const payButton = document.getElementById('payButton');
        const spinner = document.getElementById('spinner');
        const errorMessage = document.getElementById('errorMessage');

        // Check authentication state
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'auth.html?redirect=deposit';
            } else {
                // Auto-fill email for logged-in users
                document.getElementById('email').value = user.email;
            }
        });

        // Payment initiation
        payButton.addEventListener('click', async function() {
            const email = document.getElementById('email').value;
            const amount = parseFloat(document.getElementById('amount').value);
            
            // Validation
            if (!email || !amount) {
                showError('Please fill all fields');
                return;
            }
            if (amount < 2000) {
                showError('Minimum deposit is ₦2,000');
                return;
            }

            try {
                // Show loading state
                toggleLoading(true);
                
                // Get current user
                const user = auth.currentUser;
                if (!user) throw new Error('User not authenticated');
                
                // Generate unique reference
                const reference = `PI-${user.uid.slice(0, 8)}-${Date.now()}`;
                
                // Initialize Paystack payment
                const handler = PaystackPop.setup({
                    key: 'pk_live_d99488acf1205e97b3cfb64588f262d0d6ca3c9d', // REPLACE WITH YOUR PUBLIC KEY
                    email,
                    amount: amount * 100, // Convert to kobo
                    currency: 'NGN',
                    ref: reference,
                    callback: async (response) => {
                        await handlePaymentVerification(response.reference, user.uid, amount);
                    },
                    onClose: () => {
                        toggleLoading(false);
                        showError('Payment window closed');
                    }
                });
                handler.openIframe();
            } catch (error) {
                console.error('Payment error:', error);
                showError(error.message);
                toggleLoading(false);
            }
        });

        // Handle payment verification
        async function handlePaymentVerification(reference, userId, amount) {
            try {
                toggleLoading(true);
                errorMessage.style.display = 'none';
                
                // Call Firebase Cloud Function
                const verifyPayment = functions.httpsCallable('verifyPaystackPayment');
                const result = await verifyPayment({ 
                    reference, 
                    userId, 
                    amount 
                });
                
                if (result.data.success) {
                    // Redirect to success page with transaction details
                    window.location.href = `success.html?amount=${amount}&reference=${reference}`;
                } else {
                    throw new Error(result.data.error || 'Payment verification failed');
                }
            } catch (error) {
                console.error('Verification error:', error);
                showError(error.message);
            } finally {
                toggleLoading(false);
            }
        }

        // UI Helpers
        function toggleLoading(isLoading) {
            payButton.disabled = isLoading;
            spinner.style.display = isLoading ? 'inline-block' : 'none';
            payButton.innerHTML = isLoading 
                ? 'Processing... <i class="fas fa-spinner fa-spin loading" id="spinner"></i>' 
                : 'Proceed to Payment';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
    </script>
</body>
</html>
